const admin = require('firebase-admin');\nconst { PrismaClient } = require('@prisma/client');\n\nconst prisma = new PrismaClient();\n\nasync function initFirestore() {\n  if (admin.apps.length) {\n    return admin.firestore();\n  }\n\n  // Prefer FIREBASE_SERVICE_ACCOUNT JSON env, fallback to GOOGLE_APPLICATION_CREDENTIALS path\n  const serviceAccountJson = process.env.FIREBASE_SERVICE_ACCOUNT;\n  if (serviceAccountJson) {\n    const serviceAccount = JSON.parse(serviceAccountJson);\n    admin.initializeApp({\n      credential: admin.credential.cert(serviceAccount),\n    });\n  } else if (process.env.GOOGLE_APPLICATION_CREDENTIALS) {\n    admin.initializeApp({\n      credential: admin.credential.applicationDefault(),\n    });\n  } else {\n    throw new Error('Set FIREBASE_SERVICE_ACCOUNT (JSON) or GOOGLE_APPLICATION_CREDENTIALS env var before running migration.');\n  }\n\n  return admin.firestore();\n}\n\nasync function migrateCustomers(firestore) {\n  console.log('Migrating customers (clients collection)...');\n  const snapshot = await firestore.collection('clients').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    try {\n      await prisma.customer.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          companyName: data.companyName || data.name || 'Unknown',\n          customerType: data.customerType || 'domestic',\n          country: data.country || 'India',\n          state: data.state || null,\n          gstNo: data.gstNo || null,\n          billingAddress: data.billingAddress || null,\n          shippingAddress: data.shippingAddress || null,\n          contactName: data.contactPerson?.name || null,\n          contactEmail: data.contactPerson?.email || null,\n          contactPhone: data.contactPerson?.phone || null,\n          contactTitle: data.contactPerson?.designation || null,\n        },\n        update: {\n          companyName: data.companyName || data.name || 'Unknown',\n          customerType: data.customerType || 'domestic',\n          country: data.country || 'India',\n          state: data.state || null,\n          gstNo: data.gstNo || null,\n          billingAddress: data.billingAddress || null,\n          shippingAddress: data.shippingAddress || null,\n          contactName: data.contactPerson?.name || null,\n          contactEmail: data.contactPerson?.email || null,\n          contactPhone: data.contactPerson?.phone || null,\n          contactTitle: data.contactPerson?.designation || null,\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate customer', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  customers.);\n}\n\nasync function migrateLeads(firestore) {\n  console.log('Migrating leads (leads collection)...');\n  const snapshot = await firestore.collection('leads').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    try {\n      await prisma.lead.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          companyName: data.companyName || 'Unknown',\n          contactName: data.contactName || null,\n          email: data.email || null,\n          phone: data.phone || null,\n          country: data.country || null,\n          state: data.state || null,\n          gstNo: data.gstNo || null,\n          billingAddress: data.billingAddress || null,\n          shippingAddress: data.shippingAddress || null,\n          status: data.status || 'New',\n          source: data.leadSource || data.source || null,\n          notes: data.notes || null,\n        },\n        update: {\n          companyName: data.companyName || 'Unknown',\n          contactName: data.contactName || null,\n          email: data.email || null,\n          phone: data.phone || null,\n          country: data.country || null,\n          state: data.state || null,\n          gstNo: data.gstNo || null,\n          billingAddress: data.billingAddress || null,\n          shippingAddress: data.shippingAddress || null,\n          status: data.status || 'New',\n          source: data.leadSource || data.source || null,\n          notes: data.notes || null,\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate lead', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  leads.);\n}\n\nasync function migrateProducts(firestore) {\n  console.log('Migrating products (products collection)...');\n  const snapshot = await firestore.collection('products').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    try {\n      await prisma.product.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          name: data.productName || data.name || 'Product',\n          sku: data.sku || null,\n          description: data.description || null,\n          unitPrice: data.unitPrice || data.rate || 0,\n          currency: data.currency || 'INR',\n          stockQty: data.stockQty || 0,\n        },\n        update: {\n          name: data.productName || data.name || 'Product',\n          sku: data.sku || null,\n          description: data.description || null,\n          unitPrice: data.unitPrice || data.rate || 0,\n          currency: data.currency || 'INR',\n          stockQty: data.stockQty || 0,\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate product', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  products.);\n}\n\nasync function migrateQuotes(firestore) {\n  console.log('Migrating quotes (quotes collection)...');\n  const snapshot = await firestore.collection('quotes').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    const lineItems = Array.isArray(data.lineItems) ? data.lineItems : [];\n    try {\n      await prisma.quote.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          quoteNumber: data.quoteNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          validUntil: data.validUntil ? new Date(data.validUntil) : null,\n          notes: data.notes || null,\n          customerId: data.customerId,\n          leadId: data.leadId || null,\n          items: {\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n        update: {\n          quoteNumber: data.quoteNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          validUntil: data.validUntil ? new Date(data.validUntil) : null,\n          notes: data.notes || null,\n          customerId: data.customerId,\n          leadId: data.leadId || null,\n          items: {\n            deleteMany: { quoteId: doc.id },\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate quote', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  quotes.);\n}\n\nasync function migrateProformas(firestore) {\n  console.log('Migrating proforma invoices (proforma-invoices collection)...');\n  const snapshot = await firestore.collection('proforma-invoices').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    const lineItems = Array.isArray(data.lineItems) ? data.lineItems : [];\n    try {\n      await prisma.proformaInvoice.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          proformaNumber: data.proformaNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          notes: data.notes || null,\n          customerId: data.customerId,\n          quoteId: data.quoteId || null,\n          items: {\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n        update: {\n          proformaNumber: data.proformaNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          notes: data.notes || null,\n          customerId: data.customerId,\n          quoteId: data.quoteId || null,\n          items: {\n            deleteMany: { proformaId: doc.id },\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate proforma', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  proforma invoices.);\n}\n\nasync function migrateSalesOrders(firestore) {\n  console.log('Migrating sales orders (sales-orders collection)...');\n  const snapshot = await firestore.collection('sales-orders').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    const lineItems = Array.isArray(data.lineItems) ? data.lineItems : [];\n    try {\n      await prisma.salesOrder.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          orderNumber: data.orderNumber || doc.id,\n          status: data.status || 'Draft',\n          orderDate: data.orderDate ? new Date(data.orderDate) : new Date(),\n          expectedShip: data.expectedShip ? new Date(data.expectedShip) : null,\n          notes: data.notes || null,\n          customerId: data.customerId,\n          quoteId: data.quoteId || null,\n          items: {\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n        update: {\n          orderNumber: data.orderNumber || doc.id,\n          status: data.status || 'Draft',\n          orderDate: data.orderDate ? new Date(data.orderDate) : new Date(),\n          expectedShip: data.expectedShip ? new Date(data.expectedShip) : null,\n          notes: data.notes || null,\n          customerId: data.customerId,\n          quoteId: data.quoteId || null,\n          items: {\n            deleteMany: { salesOrderId: doc.id },\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate sales order', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  sales orders.);\n}\n\nasync function migrateInvoices(firestore) {\n  console.log('Migrating invoices (invoices collection)...');\n  const snapshot = await firestore.collection('invoices').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    const lineItems = Array.isArray(data.lineItems) ? data.lineItems : [];\n    try {\n      await prisma.invoice.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          invoiceNumber: data.invoiceNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          notes: data.notes || null,\n          customerId: data.customerId,\n          proformaId: data.proformaId || null,\n          salesOrderId: data.salesOrderId || null,\n          items: {\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n        update: {\n          invoiceNumber: data.invoiceNumber || doc.id,\n          status: data.status || 'Draft',\n          issueDate: data.issueDate ? new Date(data.issueDate) : new Date(),\n          notes: data.notes || null,\n          customerId: data.customerId,\n          proformaId: data.proformaId || null,\n          salesOrderId: data.salesOrderId || null,\n          items: {\n            deleteMany: { invoiceId: doc.id },\n            create: lineItems.map((item) => ({\n              productId: item.productId,\n              quantity: item.qty || item.quantity || 0,\n              unitPrice: item.rate || item.unitPrice || 0,\n              discountPct: item.discountPct || 0,\n            })),\n          },\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate invoice', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  invoices.);\n}\n\nasync function migratePayments(firestore) {\n  console.log('Migrating payments (payments collection)...');\n  const snapshot = await firestore.collection('payments').get();\n  let count = 0;\n  for (const doc of snapshot.docs) {\n    const data = doc.data();\n    try {\n      await prisma.payment.upsert({\n        where: { id: doc.id },\n        create: {\n          id: doc.id,\n          paymentDate: data.paymentDate ? new Date(data.paymentDate) : new Date(),\n          amount: data.amount || 0,\n          method: data.method || data.paymentMethod || 'Other',\n          referenceNo: data.referenceNo || data.transactionId || null,\n          notes: data.notes || null,\n          salesOrderId: data.salesOrderId || data.orderId,\n        },\n        update: {\n          paymentDate: data.paymentDate ? new Date(data.paymentDate) : new Date(),\n          amount: data.amount || 0,\n          method: data.method || data.paymentMethod || 'Other',\n          referenceNo: data.referenceNo || data.transactionId || null,\n          notes: data.notes || null,\n          salesOrderId: data.salesOrderId || data.orderId,\n        },\n      });\n      count++;\n    } catch (err) {\n      console.error('Failed to migrate payment', doc.id, err.message);\n    }\n  }\n  console.log(Migrated  payments.);\n}\n\nasync function main() {\n  console.log('Starting Firestore -> Postgres migration...');\n  console.log('Make sure DATABASE_URL and Firebase credentials env vars are set.');\n\n  try {\n    const firestore = await initFirestore();\n\n    await migrateCustomers(firestore);\n    await migrateLeads(firestore);\n    await migrateProducts(firestore);\n    await migrateQuotes(firestore);\n    await migrateProformas(firestore);\n    await migrateSalesOrders(firestore);\n    await migrateInvoices(firestore);\n    await migratePayments(firestore);\n\n    console.log('Migration completed.');\n  } catch (err) {\n    console.error('Migration failed:', err);\n    process.exitCode = 1;\n  } finally {\n    await prisma.();\n  }\n}\n\nmain();\n
