generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  firebaseUid  String       @unique
  email        String       @unique
  name         String?
  role         String       @default("user")
  passwordHash String?
  avatarUrl    String?
  twoFactorSecret String?
  is2FAEnabled Boolean      @default(false)
  failedLoginAttempts Int   @default(0)
  lockedUntil  DateTime?
  lastLoginAt  DateTime?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  leads        Lead[]       @relation("UserLeads")
  quotes       Quote[]      @relation("UserQuotes")
  sales        SalesOrder[] @relation("UserSales")
  resetTokens  PasswordResetToken[]
  sessions     Session[]
  auditLogs    AuditLog[]
  createdForms LeadCaptureForm[] @relation("FormCreator")
}

model Session {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  lastActivityAt DateTime @default(now())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String   // 'create', 'update', 'delete', 'login', 'logout', 'login_failed', 'password_change', etc.
  resource   String   // 'user', 'lead', 'customer', 'product', 'session', etc.
  resourceId String?
  details    String?  // JSON string with additional details
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())

  @@index([userId])
  @@index([resource, resourceId])
  @@index([action])
  @@index([timestamp])
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

model Customer {
  id               String            @id @default(cuid())
  srplId           String?           @unique // SRPL-CUST-000001
  companyName      String
  customerType     String
  country          String
  state            String?
  city             String?
  gstNo            String?
  billingAddress   String?
  shippingAddress  String?
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  contactTitle     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  invoices         Invoice[]
  proformaInvoices ProformaInvoice[]
  quotes           Quote[]
  salesOrders      SalesOrder[]
  deals            Deal[]
}

model Lead {
  id                  String   @id @default(cuid())
  srplId              String?  @unique // SRPL-LEAD-000001
  companyName         String
  contactName         String?
  email               String?
  phone               String?
  country             String?
  state               String?
  city                String?
  billingAddress      String?
  shippingAddress     String?
  gstNo               String?
  status              String
  source              String?
  productInterest     String?
  application         String?
  monthlyRequirement  String?
  followUpDate        DateTime?
  notes               String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  ownerId             String?
  owner               User?    @relation("UserLeads", fields: [ownerId], references: [id])
  quotes              Quote[]
  formSubmission      FormSubmission?
}

model Deal {
  id          String   @id @default(cuid())
  srplId      String?  @unique // SRPL-DEAL-000001
  title       String
  stage       String   @default("Prospecting")
  customerId  String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  customer    Customer @relation(fields: [customerId], references: [id])
  items       DealItem[]
}

model DealItem {
  id          String  @id @default(cuid())
  productId   String
  quantity    Decimal @db.Decimal(12, 2)
  dealId      String
  product     Product @relation(fields: [productId], references: [id])
  deal        Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Product {
  id              String           @id @default(cuid())
  srplId          String?          @unique // SRPL-PROD-000001
  name            String
  sku             String?          @unique
  hsnCode         String?
  description     String?
  unitPrice       Decimal          @db.Decimal(12, 2)
  currency        String           @default("INR")
  stockQty        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  invoiceItems    InvoiceItem[]
  proformaItems   ProformaItem[]
  quoteItems      QuoteItem[]
  salesOrderItems SalesOrderItem[]
  dealItems       DealItem[]
}

model Quote {
  id          String            @id @default(cuid())
  srplId      String?           @unique // SRPL-QUOT-000001
  quoteNumber String            @unique
  status      String            @default("Draft")
  issueDate   DateTime
  validUntil  DateTime?
  notes       String?
  customerId  String
  leadId      String?
  salesRepId  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  proformas   ProformaInvoice[]
  customer    Customer          @relation(fields: [customerId], references: [id])
  lead        Lead?             @relation(fields: [leadId], references: [id])
  salesRep    User?             @relation("UserQuotes", fields: [salesRepId], references: [id])
  items       QuoteItem[]
  salesOrders SalesOrder[]
}

model QuoteItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  quoteId     String
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  quote       Quote   @relation(fields: [quoteId], references: [id])
}

model SalesOrder {
  id           String           @id @default(cuid())
  srplId       String?          @unique // SRPL-SO-000001
  orderNumber  String           @unique
  status       String           @default("Draft")
  orderDate    DateTime
  expectedShip DateTime?
  notes        String?
  customerId   String
  quoteId      String?
  salesRepId   String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  invoices     Invoice[]
  payments     Payment[]
  customer     Customer         @relation(fields: [customerId], references: [id])
  quote        Quote?           @relation(fields: [quoteId], references: [id])
  salesRep     User?            @relation("UserSales", fields: [salesRepId], references: [id])
  items        SalesOrderItem[]
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  quantity     Int
  unitPrice    Decimal    @db.Decimal(12, 2)
  discountPct  Float      @default(0)
  salesOrderId String
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model Payment {
  id           String     @id @default(cuid())
  paymentDate  DateTime
  amount       Decimal    @db.Decimal(12, 2)
  method       String
  referenceNo  String?
  notes        String?
  salesOrderId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model ProformaInvoice {
  id             String         @id @default(cuid())
  srplId         String?        @unique // SRPL-PI-000001
  proformaNumber String         @unique
  status         String         @default("Draft")
  issueDate      DateTime
  notes          String?
  customerId     String
  quoteId        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  invoices       Invoice[]      @relation("ProformaInvoicesOnInvoices")
  customer       Customer       @relation(fields: [customerId], references: [id])
  quote          Quote?         @relation(fields: [quoteId], references: [id])
  items          ProformaItem[]
}

model ProformaItem {
  id          String          @id @default(cuid())
  quantity    Int
  unitPrice   Decimal         @db.Decimal(12, 2)
  discountPct Float           @default(0)
  proformaId  String
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  proforma    ProformaInvoice @relation(fields: [proformaId], references: [id])
}

model Invoice {
  id            String           @id @default(cuid())
  srplId        String?         @unique // SRPL-INV-000001
  invoiceNumber String           @unique
  status        String           @default("Draft")
  issueDate     DateTime
  notes         String?
  customerId    String
  proformaId    String?
  salesOrderId  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  customer      Customer         @relation(fields: [customerId], references: [id])
  proforma      ProformaInvoice? @relation("ProformaInvoicesOnInvoices", fields: [proformaId], references: [id])
  salesOrder    SalesOrder?      @relation(fields: [salesOrderId], references: [id])
  items         InvoiceItem[]
}

model InvoiceItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  invoiceId   String
  productId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  product     Product @relation(fields: [productId], references: [id])
}

model LeadCaptureForm {
  id          String      @id @default(cuid())
  name        String
  description String?
  slug        String      @unique
  isActive    Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdById String?
  createdBy   User?       @relation("FormCreator", fields: [createdById], references: [id])
  fields      FormField[]
  submissions FormSubmission[]
}

model FormField {
  id          String           @id @default(cuid())
  formId      String
  form        LeadCaptureForm  @relation(fields: [formId], references: [id], onDelete: Cascade)
  label       String
  fieldType   String           // 'text', 'email', 'phone', 'textarea', 'select', 'checkbox', 'number', 'date'
  placeholder String?
  required    Boolean          @default(false)
  options     String?           // JSON array for select/checkbox options
  order       Int               @default(0)
  validation  String?           // JSON object for validation rules
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@index([formId])
}

model FormSubmission {
  id          String           @id @default(cuid())
  formId      String
  form        LeadCaptureForm   @relation(fields: [formId], references: [id], onDelete: Cascade)
  leadId      String?          @unique
  lead        Lead?            @relation(fields: [leadId], references: [id], onDelete: SetNull)
  data        String           // JSON object with field values
  submittedAt DateTime         @default(now())
  ipAddress   String?
  userAgent   String?

  @@index([formId])
  @@index([leadId])
}

// SRPL Auto-Numbering System
model SequenceCounter {
  id            String   @id @default(cuid())
  moduleCode    String   // e.g., 'LEAD', 'CUST', 'INV', etc.
  currentValue  Int      @default(0)
  year          Int?     // For year-based sequences
  financialYear String?  // For FY-based sequences (e.g., 'FY25')
  lastResetAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([moduleCode, year, financialYear])
  @@index([moduleCode, year])
  @@index([moduleCode, financialYear])
}

model SequenceConfig {
  id                String   @id @default(cuid())
  moduleCode        String   @unique
  useYearPrefix     Boolean  @default(false)
  useFinancialYear  Boolean  @default(false)
  financialYearStart Int     @default(4) // Month when FY starts (1-12, default April)
  padding           Int      @default(6) // Number of digits for sequence (default 6)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}
