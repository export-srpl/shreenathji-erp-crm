generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

// Seed script configuration
// Run with: npx prisma db seed

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String               @id @default(cuid())
  firebaseUid         String               @unique
  email               String               @unique
  name                String?
  role                String               @default("user")
  salesScope          String? // 'export_sales' or 'domestic_sales' - function-based permission
  passwordHash        String?
  avatarUrl           String?
  twoFactorSecret     String?
  is2FAEnabled        Boolean              @default(false)
  failedLoginAttempts Int                  @default(0)
  lockedUntil         DateTime?
  lastLoginAt         DateTime?
  managerId           String? // Manager/team lead for team visibility
  manager             User?                @relation("UserManager", fields: [managerId], references: [id], onDelete: SetNull)
  teamMembers         User[]               @relation("UserManager")
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  leads               Lead[]               @relation("UserLeads")
  quotes              Quote[]              @relation("UserQuotes")
  sales               SalesOrder[]         @relation("UserSales")
  resetTokens         PasswordResetToken[]
  sessions            Session[]
  auditLogs           AuditLog[]
  createdForms        LeadCaptureForm[]    @relation("FormCreator")
  activities          Activity[]
  automationRules     AutomationRule[]     @relation("AutomationRuleCreator")
  rolePermissions     RolePermission[]
  uploadedDocuments   Document[]           @relation("DocumentUploader")
  documentVersions    DocumentVersion[]    @relation("DocumentVersionUploader")
  documentAccessLogs  DocumentAccessLog[]  @relation("DocumentAccessor")
  savedViews          SavedView[]
  approvalRequests    ApprovalRequest[]    @relation("ApprovalRequester")
  approvals           ApprovalRequest[]    @relation("Approver")
  securityAlerts      SecurityAlert[]
  acknowledgedAlerts  SecurityAlert[]      @relation("AlertAcknowledger")
}

model Session {
  id             String   @id @default(cuid())
  token          String   @unique
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt      DateTime
  ipAddress      String?
  userAgent      String?
  device         String? // Device type (e.g., "Desktop", "Mobile", "Tablet")
  browser        String? // Browser name (e.g., "Chrome", "Firefox", "Safari")
  os             String? // Operating system (e.g., "Windows", "macOS", "Linux", "iOS", "Android")
  city           String? // City from IP geolocation
  country        String? // Country from IP geolocation
  lastActivityAt DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  user       User?    @relation(fields: [userId], references: [id], onDelete: SetNull)
  action     String // 'create', 'update', 'delete', 'login', 'logout', 'login_failed', 'password_change', 'approval_requested', 'approval_approved', 'approval_rejected', etc.
  resource   String // 'user', 'lead', 'customer', 'product', 'session', 'pricing', 'workflow', etc.
  resourceId String?
  details    String? // JSON string with additional details (before/after values, metadata)
  ipAddress  String?
  userAgent  String?
  timestamp  DateTime @default(now())
  // Phase 4: Immutable audit log - prevent updates/deletes
  // Note: This model should NEVER be updated or deleted once created

  @@index([userId])
  @@index([resource, resourceId])
  @@index([action])
  @@index([timestamp])
  @@index([userId, action, timestamp]) // Composite index for security monitoring queries
  @@index([resource, action, timestamp]) // For resource-level audit queries
}

// Unified Activity Timeline
model Activity {
  id            String   @id @default(cuid())
  entityType    String // 'lead', 'deal', 'customer', 'product', 'quote', 'invoice', 'sales_order', etc.
  entityId      String // Primary ID (cuid)
  srplId        String? // Optional SRPL ID if available
  module        String // High-level module: 'LEAD', 'DEAL', 'CUST', 'PROD', etc.
  action        String // 'create', 'update', 'delete', 'stage_change', 'note_added', 'follow_up', 'document_added', etc.
  field         String? // Optional field name for field-level changes (e.g., 'status', 'stage')
  oldValue      String? // Previous value (stringified)
  newValue      String? // New value (stringified)
  description   String? // Human-readable summary
  metadata      String? // JSON with extra context (user agent, IP, payload snapshot, etc.)
  performedById String?
  performedBy   User?    @relation(fields: [performedById], references: [id], onDelete: SetNull)
  createdAt     DateTime @default(now())

  @@index([entityType, entityId, createdAt])
  @@index([module, createdAt])
  @@index([performedById, createdAt])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  token     String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime  @default(now())
  usedAt    DateTime?
}

model Customer {
  id               String            @id @default(cuid())
  srplId           String?           @unique // SRPL-CUST-000001
  companyName      String
  customerType     String
  isActive         Boolean           @default(true)
  country          String
  state            String?
  city             String?
  gstNo            String?
  billingAddress   String?
  shippingAddress  String?
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  contactTitle     String?
  currency         String? // Default currency for export/international customers
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  invoices         Invoice[]
  proformaInvoices ProformaInvoice[]
  quotes           Quote[]
  salesOrders      SalesOrder[]
  deals            Deal[]
  documents        Document[]
  priceHistory     PriceHistory[]
}

model Lead {
  id                 String             @id @default(cuid())
  srplId             String?            @unique // SRPL-LEAD-000001
  companyName        String
  contactName        String?
  email              String?
  phone              String?
  country            String?
  state              String?
  city               String?
  billingAddress     String?
  shippingAddress    String?
  gstNo              String?
  status             String
  statusId           String? // Reference to LeadStage
  source             String?
  sourceId           String? // Reference to LeadSource
  productInterest    String?
  application        String?
  monthlyRequirement String?
  followUpDate       DateTime?
  notes              String?
  // Phase 2: Lead Scoring & Win/Loss
  score              Int?               @default(0) // Calculated lead score (0-100)
  temperature        String? // 'Hot', 'Warm', 'Cold' - derived from score
  lastActivityDate   DateTime? // Last meaningful activity date
  winLossReasonId    String? // Reference to WinLossReason (if won/lost/disqualified)
  winLossReason      WinLossReason?     @relation(fields: [winLossReasonId], references: [id])
  wonLostAt          DateTime? // When lead was marked as won/lost/disqualified
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
  ownerId            String?
  owner              User?              @relation("UserLeads", fields: [ownerId], references: [id])
  quotes             Quote[]
  formSubmission     FormSubmission?
  stageAging         LeadStageAging[]
  scoringHistory     LeadScoreHistory[]

  @@index([statusId])
  @@index([sourceId])
  @@index([score])
  @@index([temperature])
  @@index([lastActivityDate])
  @@index([winLossReasonId])
}

model Deal {
  id              String         @id @default(cuid())
  srplId          String?        @unique // SRPL-DEAL-000001
  title           String
  stage           String         @default("Prospecting")
  stageId         String? // Reference to PipelineStage
  pipelineId      String?
  pipeline        DealPipeline?  @relation(fields: [pipelineId], references: [id], onDelete: SetNull)
  customerId      String
  // Phase 2: Win/Loss Tracking
  winLossReasonId String? // Reference to WinLossReason (if won/lost)
  winLossReason   WinLossReason? @relation("DealWinLossReason", fields: [winLossReasonId], references: [id])
  wonLostAt       DateTime? // When deal was marked as won/lost
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  customer        Customer       @relation(fields: [customerId], references: [id])
  items           DealItem[]

  @@index([pipelineId])
  @@index([stageId])
  @@index([winLossReasonId])
}

model DealItem {
  id        String  @id @default(cuid())
  productId String
  quantity  Decimal @db.Decimal(12, 2)
  dealId    String
  product   Product @relation(fields: [productId], references: [id])
  deal      Deal    @relation(fields: [dealId], references: [id], onDelete: Cascade)
}

model Product {
  id              String           @id @default(cuid())
  srplId          String?          @unique // SRPL-PROD-000001
  name            String
  sku             String?          @unique
  hsnCode         String?
  description     String?
  unitPrice       Decimal          @db.Decimal(12, 2)
  currency        String           @default("INR")
  stockQty        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  invoiceItems    InvoiceItem[]
  proformaItems   ProformaItem[]
  quoteItems      QuoteItem[]
  salesOrderItems SalesOrderItem[]
  dealItems       DealItem[]
  documents       Document[]
  priceHistory    PriceHistory[]
}

model Quote {
  id           String            @id @default(cuid())
  srplId       String?           @unique // SRPL-QUOT-000001
  quoteNumber  String            @unique
  status       String            @default("Draft")
  issueDate    DateTime
  validUntil   DateTime?
  notes        String?
  customerId   String
  leadId       String?
  salesRepId   String?
  incoTerms    String? // Inco Terms (e.g., FOB, CIF, CFR, Ex-Factory)
  paymentTerms String? // Payment Terms (e.g., Advance, 30 Days, LC)
  poNumber     String? // Purchase Order Number
  poDate       DateTime? // Purchase Order Date
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  proformas    ProformaInvoice[]
  customer     Customer          @relation(fields: [customerId], references: [id])
  lead         Lead?             @relation(fields: [leadId], references: [id])
  salesRep     User?             @relation("UserQuotes", fields: [salesRepId], references: [id])
  items        QuoteItem[]
  salesOrders  SalesOrder[]
}

model QuoteItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  quoteId     String
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  quote       Quote   @relation(fields: [quoteId], references: [id])
}

model SalesOrder {
  id           String           @id @default(cuid())
  srplId       String?          @unique // SRPL-SO-000001
  orderNumber  String           @unique
  status       String           @default("Draft")
  orderDate    DateTime
  expectedShip DateTime?
  notes        String?
  customerId   String
  quoteId      String?
  salesRepId   String?
  incoTerms    String? // Inco Terms (e.g., FOB, CIF, CFR, Ex-Factory)
  paymentTerms String? // Payment Terms (e.g., Advance, 30 Days, LC)
  poNumber     String? // Purchase Order Number
  poDate       DateTime? // Purchase Order Date
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  invoices     Invoice[]
  payments     Payment[]
  customer     Customer         @relation(fields: [customerId], references: [id])
  quote        Quote?           @relation(fields: [quoteId], references: [id])
  salesRep     User?            @relation("UserSales", fields: [salesRepId], references: [id])
  items        SalesOrderItem[]
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  quantity     Int
  unitPrice    Decimal    @db.Decimal(12, 2)
  discountPct  Float      @default(0)
  salesOrderId String
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model Payment {
  id           String     @id @default(cuid())
  paymentDate  DateTime
  amount       Decimal    @db.Decimal(12, 2)
  method       String
  referenceNo  String?
  notes        String?
  salesOrderId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model ProformaInvoice {
  id             String         @id @default(cuid())
  srplId         String?        @unique // SRPL-PI-000001
  proformaNumber String         @unique
  status         String         @default("Draft")
  issueDate      DateTime
  notes          String?
  customerId     String
  quoteId        String?
  incoTerms      String? // Inco Terms (e.g., FOB, CIF, CFR, Ex-Factory)
  paymentTerms   String? // Payment Terms (e.g., Advance, 30 Days, LC)
  poNumber       String? // Purchase Order Number
  poDate         DateTime? // Purchase Order Date
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  invoices       Invoice[]      @relation("ProformaInvoicesOnInvoices")
  customer       Customer       @relation(fields: [customerId], references: [id])
  quote          Quote?         @relation(fields: [quoteId], references: [id])
  items          ProformaItem[]
}

model ProformaItem {
  id          String          @id @default(cuid())
  quantity    Int
  unitPrice   Decimal         @db.Decimal(12, 2)
  discountPct Float           @default(0)
  proformaId  String
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  proforma    ProformaInvoice @relation(fields: [proformaId], references: [id])
}

model Invoice {
  id            String           @id @default(cuid())
  srplId        String?          @unique // SRPL-INV-000001
  invoiceNumber String           @unique
  status        String           @default("Draft")
  issueDate     DateTime
  notes         String?
  customerId    String
  proformaId    String?
  salesOrderId  String?
  incoTerms     String? // Inco Terms (e.g., FOB, CIF, CFR, Ex-Factory)
  paymentTerms  String? // Payment Terms (e.g., Advance, 30 Days, LC)
  poNumber      String? // Purchase Order Number
  poDate        DateTime? // Purchase Order Date
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  customer      Customer         @relation(fields: [customerId], references: [id])
  proforma      ProformaInvoice? @relation("ProformaInvoicesOnInvoices", fields: [proformaId], references: [id])
  salesOrder    SalesOrder?      @relation(fields: [salesOrderId], references: [id])
  items         InvoiceItem[]
}

model InvoiceItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  invoiceId   String
  productId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  product     Product @relation(fields: [productId], references: [id])
}

// Customer Price & Rate History - Read-only audit trail
model PriceHistory {
  id           String   @id @default(cuid())
  customerId   String
  customer     Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId    String
  product      Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  documentType String // 'Quote', 'ProformaInvoice', 'SalesOrder', 'Invoice'
  documentId   String // ID of the source document
  documentNo   String // Document number (quoteNumber, invoiceNumber, etc.)
  documentDate DateTime // Date from the source document
  quantity     Int
  unitPrice    Decimal  @db.Decimal(12, 2)
  discountPct  Float    @default(0)
  currency     String   @default("INR")
  createdAt    DateTime @default(now()) // When this history entry was created

  @@index([customerId, createdAt])
  @@index([productId, createdAt])
  @@index([documentType, documentId])
  @@index([documentDate])
  @@index([customerId, productId, createdAt])
}

model LeadCaptureForm {
  id          String           @id @default(cuid())
  name        String
  description String?
  slug        String           @unique
  isActive    Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  createdById String?
  createdBy   User?            @relation("FormCreator", fields: [createdById], references: [id])
  fields      FormField[]
  submissions FormSubmission[]
}

model FormField {
  id          String          @id @default(cuid())
  formId      String
  form        LeadCaptureForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  label       String
  fieldType   String // 'text', 'email', 'phone', 'textarea', 'select', 'checkbox', 'number', 'date'
  placeholder String?
  required    Boolean         @default(false)
  options     String? // JSON array for select/checkbox options
  order       Int             @default(0)
  validation  String? // JSON object for validation rules
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@index([formId])
}

model FormSubmission {
  id          String          @id @default(cuid())
  formId      String
  form        LeadCaptureForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  leadId      String?         @unique
  lead        Lead?           @relation(fields: [leadId], references: [id], onDelete: SetNull)
  data        String // JSON object with field values
  submittedAt DateTime        @default(now())
  ipAddress   String?
  userAgent   String?

  @@index([formId])
  @@index([leadId])
}

// SRPL Auto-Numbering System
model SequenceCounter {
  id            String   @id @default(cuid())
  moduleCode    String // e.g., 'LEAD', 'CUST', 'INV', etc.
  currentValue  Int      @default(0)
  year          Int? // For year-based sequences
  financialYear String? // For FY-based sequences (e.g., 'FY25')
  lastResetAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([moduleCode, year, financialYear])
  @@index([moduleCode, year])
  @@index([moduleCode, financialYear])
}

model SequenceConfig {
  id                 String   @id @default(cuid())
  moduleCode         String   @unique
  useYearPrefix      Boolean  @default(false)
  useFinancialYear   Boolean  @default(false)
  financialYearStart Int      @default(4) // Month when FY starts (1-12, default April)
  padding            Int      @default(6) // Number of digits for sequence (default 6)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
}

// Workflow Configuration System
model DealPipeline {
  id          String          @id @default(cuid())
  name        String
  description String?
  isDefault   Boolean         @default(false)
  isActive    Boolean         @default(true)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  stages      PipelineStage[]
  deals       Deal[]

  @@index([isDefault])
  @@index([isActive])
}

model PipelineStage {
  id          String       @id @default(cuid())
  pipelineId  String
  pipeline    DealPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  name        String
  order       Int          @default(0)
  stageType   String       @default("open") // 'open', 'won', 'lost'
  probability Int? // 0-100: probability of closing at this stage (for weighted pipeline)
  isMandatory Boolean      @default(false)
  isTerminal  Boolean      @default(false)
  color       String? // Hex color code
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  @@unique([pipelineId, name])
  @@index([pipelineId, order])
}

model LeadStage {
  id        String   @id @default(cuid())
  name      String   @unique
  order     Int      @default(0)
  stageType String   @default("active") // 'active', 'converted', 'disqualified'
  color     String? // Hex color code
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([order])
  @@index([isActive])
}

model LeadSource {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

model Label {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String // Hex color code (required)
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive])
}

// Workflow Automation Engine
model AutomationRule {
  id          String    @id @default(cuid())
  name        String
  description String?
  module      String // 'LEAD', 'DEAL', etc.
  triggerType String // 'on_create', 'on_update', 'on_stage_change', 'time_based'
  isActive    Boolean   @default(true)
  priority    Int       @default(0) // Lower number = higher priority
  // JSON condition describing when to fire (optional).
  // For example: { "type": "field_compare", "field": "status", "op": "equals", "value": "Converted" }
  condition   String?
  // Array of actions to execute when rule fires.
  // For example: [{ "type": "update_field", "field": "ownerId", "value": "user-id" }]
  actions     String
  // Phase 2: Time-based execution support
  schedule    String? // For time_based triggers: cron expression or interval (e.g., "daily", "weekly")
  lastRunAt   DateTime? // Track last execution time
  nextRunAt   DateTime? // When to run next (for time_based rules)

  createdById String?
  createdBy   User?    @relation("AutomationRuleCreator", fields: [createdById], references: [id], onDelete: SetNull)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([module, triggerType, isActive])
  @@index([nextRunAt]) // For efficient time-based querying
}

// RBAC: Permission System
model Permission {
  id              String           @id @default(cuid())
  resource        String // 'lead', 'deal', 'customer', 'product', 'quote', 'invoice', etc.
  action          String // 'view', 'create', 'update', 'delete', 'view_all', 'edit_all'
  field           String? // Optional: specific field name (e.g., 'unitPrice', 'margin', 'gstNo')
  scope           String           @default("own") // 'own', 'team', 'all'
  description     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  rolePermissions RolePermission[]

  @@unique([resource, action, field, scope])
  @@index([resource, action])
}

model RolePermission {
  id           String     @id @default(cuid())
  role         String // 'admin', 'sales', 'finance', 'manager', 'user'
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  userId       String?
  user         User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@unique([role, permissionId])
  @@index([role])
  @@index([permissionId])
}

// Document and Compliance Management
model Document {
  id           String              @id @default(cuid())
  name         String
  type         String // 'COA', 'TDS', 'MSDS', 'contract', 'approval', 'regulatory'
  description  String?
  entityType   String // 'product', 'customer', 'lead', 'deal', 'quote', 'invoice'
  entityId     String // ID of the related entity
  productId    String? // Required for COA, TDS, MSDS
  product      Product?            @relation(fields: [productId], references: [id], onDelete: Cascade)
  customerId   String? // Required for contract
  customer     Customer?           @relation(fields: [customerId], references: [id], onDelete: Cascade)
  mimeType     String?
  fileSize     Int? // bytes
  filePath     String? // Storage path (S3, local, etc.)
  fileUrl      String? // Public/private URL
  isPublic     Boolean             @default(false)
  isScanned    Boolean             @default(false) // Virus scan status
  scanResult   String? // 'clean', 'infected', 'error'
  uploadedById String?
  uploadedBy   User?               @relation("DocumentUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  createdAt    DateTime            @default(now())
  updatedAt    DateTime            @updatedAt
  versions     DocumentVersion[]
  accessLogs   DocumentAccessLog[]

  @@index([entityType, entityId])
  @@index([type])
  @@index([uploadedById])
  @@index([productId])
  @@index([customerId])
}

model DocumentVersion {
  id           String   @id @default(cuid())
  documentId   String
  document     Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  version      Int      @default(1)
  name         String
  filePath     String?
  fileUrl      String?
  fileSize     Int?
  mimeType     String?
  changeNotes  String?
  uploadedById String?
  uploadedBy   User?    @relation("DocumentVersionUploader", fields: [uploadedById], references: [id], onDelete: SetNull)
  createdAt    DateTime @default(now())

  @@unique([documentId, version])
  @@index([documentId])
}

model DocumentAccessLog {
  id         String   @id @default(cuid())
  documentId String
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  userId     String?
  user       User?    @relation("DocumentAccessor", fields: [userId], references: [id], onDelete: SetNull)
  action     String // 'view', 'download', 'upload', 'delete', 'share'
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([documentId])
  @@index([userId])
  @@index([createdAt])
}

// Phase 4: Approval Workflows
model ApprovalWorkflow {
  id               String            @id @default(cuid())
  name             String
  description      String?
  resource         String // 'pricing', 'discount', 'tax_override', 'document_deletion', 'workflow_rule', etc.
  action           String // 'create', 'update', 'delete', 'override'
  thresholdValue   Decimal?          @db.Decimal(12, 2) // For numeric thresholds (e.g., discount > 20%)
  thresholdField   String? // Field name for threshold comparison
  requiresApproval Boolean           @default(true)
  approverRoles    String[] // Array of role names that can approve (e.g., ['manager', 'admin'])
  approverUserIds  String[] // Array of specific user IDs that can approve
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  requests         ApprovalRequest[]

  @@index([resource, action])
  @@index([isActive])
}

model ApprovalRequest {
  id              String            @id @default(cuid())
  workflowId      String?
  workflow        ApprovalWorkflow? @relation(fields: [workflowId], references: [id], onDelete: SetNull)
  resource        String // 'pricing', 'discount', 'tax_override', 'document_deletion', etc.
  resourceId      String // ID of the resource being approved
  action          String // 'create', 'update', 'delete', 'override'
  status          String            @default("pending") // 'pending', 'approved', 'rejected', 'cancelled'
  requestedById   String
  requestedBy     User              @relation("ApprovalRequester", fields: [requestedById], references: [id], onDelete: Cascade)
  approvedById    String?
  approvedBy      User?             @relation("Approver", fields: [approvedById], references: [id], onDelete: SetNull)
  requestedAt     DateTime          @default(now())
  reviewedAt      DateTime?
  reason          String? // Reason for the request
  rejectionReason String? // Reason for rejection (if rejected)
  metadata        String? // JSON with request details (before/after values, threshold info, etc.)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([status])
  @@index([resource, resourceId])
  @@index([requestedById])
  @@index([approvedById])
  @@index([requestedAt])
  @@index([workflowId])
}

// Phase 4: Security Alerts & Anomaly Detection
model SecurityAlert {
  id               String    @id @default(cuid())
  type             String // 'new_login_location', 'failed_login', 'bulk_operation', 'pricing_override', 'suspicious_activity', etc.
  severity         String    @default("medium") // 'low', 'medium', 'high', 'critical'
  title            String
  description      String?
  userId           String?
  user             User?     @relation(fields: [userId], references: [id], onDelete: SetNull)
  resource         String? // Resource type (e.g., 'lead', 'pricing', 'session')
  resourceId       String? // Resource ID
  metadata         String? // JSON with alert details (IP, device, action details, etc.)
  acknowledged     Boolean   @default(false)
  acknowledgedAt   DateTime?
  acknowledgedById String?
  acknowledgedBy   User?     @relation("AlertAcknowledger", fields: [acknowledgedById], references: [id], onDelete: SetNull)
  createdAt        DateTime  @default(now())

  @@index([type])
  @@index([severity])
  @@index([userId])
  @@index([acknowledged])
  @@index([createdAt])
  @@index([type, severity, createdAt]) // For alert filtering queries
}

// Phase 2: Lead Scoring & Aging
model LeadStageAging {
  id          String    @id @default(cuid())
  leadId      String
  lead        Lead      @relation(fields: [leadId], references: [id], onDelete: Cascade)
  stageId     String? // Reference to LeadStage
  stageName   String // Denormalized stage name for historical accuracy
  enteredAt   DateTime  @default(now()) // When lead entered this stage
  exitedAt    DateTime? // When lead left this stage (null if still in stage)
  daysInStage Int? // Calculated days in stage (for exited stages)

  @@index([leadId])
  @@index([stageId])
  @@index([enteredAt])
}

model LeadScoreHistory {
  id           String   @id @default(cuid())
  leadId       String
  lead         Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  score        Int // Score at this point in time
  temperature  String // 'Hot', 'Warm', 'Cold'
  reason       String? // Brief explanation of score change
  calculatedAt DateTime @default(now())

  @@index([leadId, calculatedAt])
  @@index([calculatedAt])
}

model LeadScoringConfig {
  id                    String   @id @default(cuid())
  name                  String   @unique // Configuration name
  isActive              Boolean  @default(true)
  isDefault             Boolean  @default(false) // Only one default config at a time
  // JSON configuration for scoring rules
  // Example: { "criteria": [{ "field": "leadAge", "weight": 20, "rules": [...] }] }
  rules                 String // JSON string with scoring rules
  temperatureThresholds String? // JSON: { "hot": 70, "warm": 40, "cold": 0 }
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@index([isActive, isDefault])
}

// Phase 2: Win/Loss Reasons
model WinLossReason {
  id          String   @id @default(cuid())
  name        String   @unique
  type        String // 'win', 'loss', 'disqualify'
  module      String // 'LEAD', 'DEAL' - which module this applies to
  description String?
  isActive    Boolean  @default(true)
  order       Int      @default(0) // Display order
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  leads       Lead[]
  deals       Deal[]   @relation("DealWinLossReason")

  @@index([type, module, isActive])
  @@index([order])
}

// Phase 2: Saved Views & Personal Productivity
model SavedView {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name      String // User-friendly name
  module    String // 'LEAD', 'DEAL', 'CUSTOMER', etc.
  // JSON string with filter configuration
  // Example: { "status": ["Hot", "Warm"], "ownerId": "user-id", "dateRange": {...} }
  filters   String // JSON string with filter criteria
  sortBy    String? // Sort field
  sortOrder String? // 'asc' | 'desc'
  isDefault Boolean  @default(false) // Default view for this module
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, module, name]) // One view name per module per user
  @@index([userId, module])
}
