generator client {
  provider   = "prisma-client-js"
  engineType = "binary"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String       @id @default(cuid())
  firebaseUid  String       @unique
  email        String       @unique
  name         String?
  role         String       @default("user")
  passwordHash String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  leads        Lead[]       @relation("UserLeads")
  quotes       Quote[]      @relation("UserQuotes")
  sales        SalesOrder[] @relation("UserSales")
  resetTokens  PasswordResetToken[]
}

model PasswordResetToken {
  id        String   @id @default(cuid())
  token     String   @unique
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  expiresAt DateTime
  createdAt DateTime @default(now())
  usedAt    DateTime?
}

model Customer {
  id               String            @id @default(cuid())
  companyName      String
  customerType     String
  country          String
  state            String?
  gstNo            String?
  billingAddress   String?
  shippingAddress  String?
  contactName      String?
  contactEmail     String?
  contactPhone     String?
  contactTitle     String?
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  invoices         Invoice[]
  proformaInvoices ProformaInvoice[]
  quotes           Quote[]
  salesOrders      SalesOrder[]
}

model Lead {
  id              String   @id @default(cuid())
  companyName     String
  contactName     String?
  email           String?
  phone           String?
  country         String?
  state           String?
  gstNo           String?
  billingAddress  String?
  shippingAddress String?
  status          String
  source          String?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  ownerId         String?
  owner           User?    @relation("UserLeads", fields: [ownerId], references: [id])
  quotes          Quote[]
}

model Product {
  id              String           @id @default(cuid())
  name            String
  sku             String?          @unique
  description     String?
  unitPrice       Decimal          @db.Decimal(12, 2)
  currency        String           @default("INR")
  stockQty        Int              @default(0)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  invoiceItems    InvoiceItem[]
  proformaItems   ProformaItem[]
  quoteItems      QuoteItem[]
  salesOrderItems SalesOrderItem[]
}

model Quote {
  id          String            @id @default(cuid())
  quoteNumber String            @unique
  status      String            @default("Draft")
  issueDate   DateTime
  validUntil  DateTime?
  notes       String?
  customerId  String
  leadId      String?
  salesRepId  String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  proformas   ProformaInvoice[]
  customer    Customer          @relation(fields: [customerId], references: [id])
  lead        Lead?             @relation(fields: [leadId], references: [id])
  salesRep    User?             @relation("UserQuotes", fields: [salesRepId], references: [id])
  items       QuoteItem[]
  salesOrders SalesOrder[]
}

model QuoteItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  quoteId     String
  productId   String
  product     Product @relation(fields: [productId], references: [id])
  quote       Quote   @relation(fields: [quoteId], references: [id])
}

model SalesOrder {
  id           String           @id @default(cuid())
  orderNumber  String           @unique
  status       String           @default("Draft")
  orderDate    DateTime
  expectedShip DateTime?
  notes        String?
  customerId   String
  quoteId      String?
  salesRepId   String?
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  invoices     Invoice[]
  payments     Payment[]
  customer     Customer         @relation(fields: [customerId], references: [id])
  quote        Quote?           @relation(fields: [quoteId], references: [id])
  salesRep     User?            @relation("UserSales", fields: [salesRepId], references: [id])
  items        SalesOrderItem[]
}

model SalesOrderItem {
  id           String     @id @default(cuid())
  quantity     Int
  unitPrice    Decimal    @db.Decimal(12, 2)
  discountPct  Float      @default(0)
  salesOrderId String
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model Payment {
  id           String     @id @default(cuid())
  paymentDate  DateTime
  amount       Decimal    @db.Decimal(12, 2)
  method       String
  referenceNo  String?
  notes        String?
  salesOrderId String
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  salesOrder   SalesOrder @relation(fields: [salesOrderId], references: [id])
}

model ProformaInvoice {
  id             String         @id @default(cuid())
  proformaNumber String         @unique
  status         String         @default("Draft")
  issueDate      DateTime
  notes          String?
  customerId     String
  quoteId        String?
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  invoices       Invoice[]      @relation("ProformaInvoicesOnInvoices")
  customer       Customer       @relation(fields: [customerId], references: [id])
  quote          Quote?         @relation(fields: [quoteId], references: [id])
  items          ProformaItem[]
}

model ProformaItem {
  id          String          @id @default(cuid())
  quantity    Int
  unitPrice   Decimal         @db.Decimal(12, 2)
  discountPct Float           @default(0)
  proformaId  String
  productId   String
  product     Product         @relation(fields: [productId], references: [id])
  proforma    ProformaInvoice @relation(fields: [proformaId], references: [id])
}

model Invoice {
  id            String           @id @default(cuid())
  invoiceNumber String           @unique
  status        String           @default("Draft")
  issueDate     DateTime
  notes         String?
  customerId    String
  proformaId    String?
  salesOrderId  String?
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  customer      Customer         @relation(fields: [customerId], references: [id])
  proforma      ProformaInvoice? @relation("ProformaInvoicesOnInvoices", fields: [proformaId], references: [id])
  salesOrder    SalesOrder?      @relation(fields: [salesOrderId], references: [id])
  items         InvoiceItem[]
}

model InvoiceItem {
  id          String  @id @default(cuid())
  quantity    Int
  unitPrice   Decimal @db.Decimal(12, 2)
  discountPct Float   @default(0)
  invoiceId   String
  productId   String
  invoice     Invoice @relation(fields: [invoiceId], references: [id])
  product     Product @relation(fields: [productId], references: [id])
}
